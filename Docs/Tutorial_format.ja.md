# formatスクリプト チュートリアル

以下の内容は、
[チュートリアル](Tutorial.ja.md)の「インストール（というか配置）」が実施済であることを前提としています。

* [まず単純に変換してみる](#まず単純に変換してみる)
* [titleの扱い](#titleの扱い)
* [画像リンクなどの扱い](#画像リンクなどの扱い)
* [フォーマッティングのためのパラメータを設定する（ソース毎編）](#フォーマッティングのためのパラメータを設定する（ソース毎編）)
* [フォーマッティングのためのパラメータを設定する（全体編）](#フォーマッティングのためのパラメータを設定する（全体編）)
* [スタイルシートを指定する](#スタイルシートを指定する)


## まず単純に変換してみる

`_scripts`ディレクトリを作業ディレクトリとして、
PowerShellで`format`スクリプト（`format.ps1`）を実行します。

```
PS C:\Work\_scripts> ./format.ps1
```

すると、`md`ディレクトリ下の.mdファイルがHTMLファイルに変換され、
`html`ディレクトリ下に格納されます。
この時、.mdファイル中の相対リンクは、拡張子が.mdであれば.htmlへ書き換えられます。

例えば、`md/a.md`中にある以下の記述は、

```markdown
* [b](b.md)
* [y](x/y.md#z)
```

変換後の`html/a.html`中では以下のように変換されています。

```html
<ul>
  <li><a href="b.html">b</a></li>
  <li><a href="x/y.html#z">y</a></li>
</ul>
```

（生成後のhtmlマークアップ例は説明のために単純化しています。
以下の例でも同様です。）

通常、`format`スクリプトは更新されたソースファイルのみ変換します。
更新されているかどうかにかかわらず、
すべてのソースファイルを変換する場合は、`Rebuild`オプションを指定してスクリプトを実行します。

```
PS C:\Work\_scripts> ./format.ps1 -Rebuild
```


## titleの扱い

pandocでスタンドアロンなhtmlドキュメントを生成する場合、
titleの扱いが面倒です。
pandocではtitleはメタデータで与えられるものと想定されています。
「メタデータ」はソース中に特殊な記法で埋め込んだり、
pandocへのコマンドライン等で与えたりする文書情報です。

スタンドアロンなhtmlへの変換を行う場合、
pandocは以下のように動作します。

* ソースに`title`メタデータが存在しないと警告を出し、ソースファイル名が`title`として扱われる。
* ソースに`title`メタデータがあれば、それを`h1`要素としてHTML本体の先頭に生成する。
* ソースにlevel-1のヘッダが存在すれば（普通存在する）、
  結果として複数の`h1`要素が生成されてしまう。
  典型的な場合、文書の先頭にほぼ同じ内容の`h1`要素が二つ並んでしまう。

この問題に対処するため、
`format`スクリプトは変換時に以下を行います。

* ソース中のlevel-1ヘッダは削除します。
* ただし、ソースに`title`メタデータが存在しない場合は、
  最初のlevel-1ヘッダと同等の内容を`title`メタデータとして追加します。

要するに、ソースにはlevel-1ヘッダを文書先頭にただ一つ書くようにしておけば、
`title`メタデータを用意しなくとも、だいたい常識的に期待する変換結果になります。


## 画像リンクなどの扱い

例えば、`md/a.md`に以下の画像リンクがある場合、

```markdown
![画像](image.png)
```

変換時になにも細工しないと、`html/a.html`には以下のようなHTMLが生成されます。

```html
<image src="image.png" alt="画像" />
```

ところが、`a.html`は元々の`a.md`とは別のディレクトリに出力されているので、このリンクは切れてしまっています。

このため、`format`スクリプトは、
変換対象外のファイルを指す相対リンクを（正確にはリンクの拡張子マッピング対象外の相対リンクを）、
変換後のファイルを起点としたものに書き換えます。
この操作をリンクのリベース（rebase）と呼びます。

例えば、上の例では、変換後のHTMLは実際には以下になります。

```html
<image src="../md/image.png" alt="画像" />
```

通常はこの動作の方が望ましいでしょうが、
変換後のドキュメントをひとまとめにしておきたい場合もあるでしょう。
例えば、あとで変換後ドキュメントをまとめて移動させたい場合、
この挙動だと変換したドキュメントと画像などが別々のフォルダに格納されており、取り扱いが不便になります。

このような場合のために、
`format`スクリプトには「リベースしない」モードも用意されています。
このモードの場合、

* 変換対象外のファイルは出力フォルダにそのままコピーされ、
* そのファイルへの相対リンクは変更されません。

このモードで変換を行うには、
`format`スクリプトの`RebaseOtherRelativeLinks`オプションを`false`に設定します。

```
PS C:\Work\_scripts> ./format.ps1 -RebaseOtherRelativeLinks $false
```

この動作をデフォルトにしたい場合は、
`format.ps1`スクリプトの以下の部分を書き換えます。

```powershell
...
param (
    ...
    [bool]$rebaseOtherRelativeLinks = $false, # ここをfalseにする
    ...
)

```

PowerShellでは、変数名やオプション名の大文字小文字を区別しません。
スクリプト中では変数は基本的にCamel Caseで記述しています。
しかし、上のコマンドラインの例のように、
オプション名として表記する場合は、
コマンドレットのドキュメントの慣習に従って、
Pascal Caseで記述することにします。


## フォーマッティングのためのパラメータを設定する（ソース毎編）

pandocでは出力形式へのフォーマッティングに用いるパラメータをメタデータで指定します。
例えば、HTMLでは`html`要素に`lang`属性を指定することが推奨されています。
この属性値をフォーマットさせるには、`lang`メタデータをpandocに指定します。

`Pandoc's Markdown`ではmarkdown文書中にメタデータを埋め込む構文が用意されています。しかし、メタデータを文書中に埋め込むとmarkdown文書としての互換性が下がりますし、フォーマッティングに関する指定は文書本体とはなるべく分離しておくことが望ましいでしょう。

`format`スクリプトでは、ソースと同じディレクトリに`(ソースファイル名).metadata.yaml`というファイルがあれば、それをそのソースのメタデータが記述されているファイルとして処理をします。

例えば、`md/a.md`に対し、
以下の内容をもつ`md/a.md.metadata.yaml`という名前のファイルがあれば、
`format`スクリプトはその内容を`md/a.md`のメタデータとして処理を行います。
結果として変換後のHTMLに`lang`属性が設定されます。

```yaml
lang: "ja"
```

このメタデータファイルはYAML形式で記述します。


## フォーマッティングのためのパラメータを設定する（全体編）

前項ではソースファイルに対して`lang`メタデータを指定しました。
しかし、`lang`属性の設定は一群のソースファイルのほとんどで同じでしょうから、
フォーマット全体に対する設定として`lang`メタデータを指定し、必要なソースファイルのみソースファイル毎の設定で上書きした方がよいでしょう。

フォーマット全体に適用するメタデータを指定するには、
まずメタデータを記述したYAMLファイルを作成します。

ここでは、以下の内容をもつ`_scripts/html.metadata.yaml`ファイルを作成します。

```yaml
lang: "ja"
```

次に、このファイルを`format`スクリプトの`MetadataFiles`オプションに指定します。

```
PS C:\Work\_scripts> ./format.ps1 -MetadataFiles 'html.metadata.yaml'
```

この動作をデフォルトにしたい場合は、
`format.ps1`スクリプトの以下の部分を書き換えます。

```powershell
...
param (
    ...
    [string[]]$metadataFiles = @('html.metadata.yaml'), # メタデータを指定
    ...
)

```

メタデータファイルは複数指定することができます。
複数指定する場合は、PowerShellの配列構文で指定します。

```
PS C:\Work\_scripts> ./format.ps1 -MetadataFiles '1.metadata.yaml','2.metadata.yaml'
```

同じ名前のメタデータが複数指定された場合、
後で指定されたものが有効になります。
ソースファイルに対するメタデータはフォーマット全体に対するメタデータの後に結合されます。


## スタイルシートを指定する

変換後のHTMLファイルにスタイルシートを適用したい場合は、
`css`メタデータを指定します。
例えば、前項で作成した変換全体に適用するメタデータファイル`_scripts/html.metadata.yaml`に`css`メタデータを追加します。

```yaml
lang: "ja"
css: "styles/style.css"
```

`css`メタデータは配列にすることもできます。

```yaml
lang: "ja"
css:
  - "styles/style.css"
  - "styles/style2.css"
```

しかし、この設定には問題があります。
これらのスタイルシートが`html/styles`ディレクトリに格納されている場合、
このメタデータを元にフォーマットされた`html/a.html`では正しくスタイルシートを参照できますが、
`html/subdir/b.html`では参照できません。
`html/subdir/b.html`中ではスタイルシートへの相対URIは`../styles/style.css`でなければならないからです。

この問題に対応するため、
`format`スクリプトはメタデータに対するマクロ機能を提供しています。

```yaml
lang: "ja"
css: { _macro: "rebase", target: "styles/style.css" }
```

マクロは、`_macro`という名前のエントリをもつ連想配列の形式をしており、
`_macro`の値がマクロの名前、
`_macro`以外のエントリがそのマクロのパラメーターになります。
マクロは、変換時にマクロ全体を適切な値に置き換えます。

この例では、`rebase`マクロが指定されており、
`rebase`マクロは変換時に、

* `target`の値を出力ディレクトリ（この場合`html`ディレクトリ）からの相対パスとみなし、
* 変換後ファイルからの相対パスにリベースし、その値でマクロ全体を置き換えます。

つまり、`html/a.html`に対しては`css`の値は`styles/style.css`となり、
`html/subdir/b.html`に対しては`../styles/style.css`となります。

`css`が配列の場合でもマクロを適用することができます。

```yaml
lang: "ja"
css:
  - { _macro: "rebase", target: "styles/style.css" }
  - { _macro: "rebase", target: "styles/style2.css" }
```
