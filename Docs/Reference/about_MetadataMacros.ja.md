# メタデータマクロについて

* [簡易説明](#簡易説明)
* [詳細説明](#詳細説明)
* [マクロリファレンス](#マクロリファレンス)


## 簡易説明

メタデータマクロ機能について説明します。


## 詳細説明

`Panasu`が提供するpandocフィルターにはメタデータマクロをサポートしていうものがあります。
ソースドキュメントをそれらのフィルターを用いて変換する際に、
ソースドキュメントのメタデータの値としてマクロを記述することができます。

基本的に、`Panasu`におけるソースドキュメントの変換は以下のように実行されます。

1. `pandoc`がソースドキュメントファイルを読み込み、それをAST (Abstract Syntax Tree)に変換します。
2. 指定されたフィルターがASTを変更します。
3. `pandoc`がフィルターされたASTを読み込み、目的の形式で出力します。

この過程において、フィルターはASTに含まれるメタデータのマクロを展開します。
結果として、フィルターは展開されたメタデータの値を含むASTを出力し、
それが最終的な出力ドキュメントに反映されます。

フィルターがどの種類のマクロをサポートするかはフィルターによって異なります。
フィルターの説明を参照してください。

YAMLメタデータブロック中のマクロは以下のようになります:

```yaml
metadata-1:
  _macro: "condition"
  from-file: "a.md"
  true-case: "this document"
  false-case: "document a"
```

この例では`metadata-1`の値がマクロになっています。
マクロは`_macro`キーをもつマッピングです。
`_macro`キーの値はマクロの種類を表し、
その他のキーはマクロのパラメーターとなります。
この例では、このマクロは`condition`マクロであり、
三つのパラメーター`from-file`, `true-case`, `false-case`が記述されています。

メタデータマクロはドキュメントの変換過程でフィルタによって展開されます。
以下は上の`metadata-1`メタデータの展開例です。

```yaml
metadata-1: "this document"
```

マクロがどのように展開されるかはマクロの種類によって異なります。
詳細は[マクロリファレンス](#マクロリファレンス)を参照してください。


## マクロリファレンス

### condition マクロ

`condition`マクロは、後述する「条件」に応じて展開されます。

もし条件がtrueならば、展開される値は以下になります。

* `true-case`パラメーターが存在する場合は、その値
* `true-case`パラメーターが存在しない場合は、null

もし条件がfalseならば、展開される値は以下になります。

* `false-case`パラメーターが存在する場合は、その値
* `false-case`パラメーターが存在しない場合は、null

展開された値がnullならば、メタデータ自体が削除されます。

このマクロは、以下の条件をサポートしています。

#### from-file 条件

もしマクロが`from-file`パラメーターを持つ場合、from-file条件が評価されます.

from-file条件は、ソースドキュメントのパスが`from-file`パラメーターの値と同じならばtrueになります。
パスはソースドキュメントのベースディレクトリからの相対パスとして比較されます。
また、比較では大文字小文字を区別しません。

例えば、以下のメタデータは、

```yaml
css:
  _macro: "condition"
  from-file: "toc.md"
  true-case: "toc.css"
  false-case: "doc.css"
```

これが"toc.md"のメタデータである場合は以下のように展開されます。

```yaml
css: "toc.css"
```

それ以外の場合は、以下のように展開されます。

```yaml
css: "doc.css"
```

### rebase macro

`rebase`マクロを展開した値は、`target`パラメーターの値をリベースしたものになります.
`target`パラメーターの値は、絶対パスまたは変換されたドキュメントファイルの出力先となるディレクトリからの相対パスです。

* 絶対パスの場合、そのパスがそのまま展開された値になります。
* 相対パスの場合、相対パスを変換されたドキュメントファイルからの相対パスにリベースした相対パスが展開された値になります。

例えば、以下の"subdir/a.md"のメタデータは、

```yaml
css: 
  _macro: "rebase"
  target: "styles/doc.css"
```

以下のように展開されます。

```yaml
css: "../styles/doc.css"
```
